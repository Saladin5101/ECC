# ç¼–è¯‘å™¨ä¸Žç¼–è¯‘é€‰é¡¹é…ç½®
CC = gcc
CFLAGS = -I src/ -w -Wno-error  # å®½æ¾ç¼–è¯‘ï¼šå…³é—­æ‰€æœ‰è­¦å‘Šï¼Œä¸æŠŠè­¦å‘Šå½“é”™è¯¯
RELEASE_FLAGS = -O2  # Release ç‰ˆï¼šä¼˜åŒ–ä»£ç ä½“ç§¯ä¸Žé€Ÿåº¦
DEBUG_FLAGS = -g -O0  # Debug ç‰ˆï¼šä¿ç•™è°ƒè¯•ç¬¦å·ï¼Œå…³é—­ä¼˜åŒ–ï¼ˆæ–¹ä¾¿ gdb è°ƒè¯•ï¼‰
TARGET = elfc-compiler  # Release ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶å
DEBUG_TARGET = elfc-compiler-dbg  # Debug ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶å

# é¡¹ç›®æ‰€æœ‰æºä»£ç æ–‡ä»¶ï¼ˆç¡®ä¿åŒ…å«æ‰€æœ‰ .c æ–‡ä»¶ï¼Œé¿å…æ¼ç¼–è¯‘ï¼‰
SRC_FILES = src/main.c src/cli/cli.c src/codegen/codegen.c src/common/utils.c src/lexer/lexer.c src/module/modules.c src/parser/parser.c

# -------------------------- åŸºç¡€ç¼–è¯‘ç›®æ ‡ --------------------------
# é»˜è®¤ç›®æ ‡ï¼šç¼–è¯‘ Release ç‰ˆç¼–è¯‘å™¨
all:
	$(CC) $(SRC_FILES) $(CFLAGS) $(RELEASE_FLAGS) -o $(TARGET)
	@echo "âœ… Release ç‰ˆç¼–è¯‘å®Œæˆï¼å¯æ‰§è¡Œæ–‡ä»¶ï¼š./$(TARGET)"

# ç¼–è¯‘ Debug ç‰ˆç¼–è¯‘å™¨ï¼ˆå¸¦è°ƒè¯•ç¬¦å·ï¼‰
debug:
	$(CC) $(SRC_FILES) $(CFLAGS) $(DEBUG_FLAGS) -o $(DEBUG_TARGET)
	@echo "âœ… Debug ç‰ˆç¼–è¯‘å®Œæˆï¼å¯æ‰§è¡Œæ–‡ä»¶ï¼š./$(DEBUG_TARGET)"

# æ¸…ç†æ‰€æœ‰ç¼–è¯‘äº§ç‰©ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ã€æ‰“åŒ…ç›®å½•ã€äºŒè¿›åˆ¶è¾“å‡ºï¼‰
clean:
	rm -rf $(TARGET) $(DEBUG_TARGET) ecc-mvp *.bin
	@echo "âœ… æ‰€æœ‰ç¼–è¯‘äº§ç‰©å·²æ¸…ç†å®Œæˆï¼"

# -------------------------- ä¸€é”®æ‰“åŒ…ç›®æ ‡ --------------------------
# ä¾èµ– all ç›®æ ‡ï¼šå…ˆç¼–è¯‘ Release ç‰ˆï¼Œå†æ‰“åŒ…
package: all
	# 1. åˆ›å»ºæ‰“åŒ…ç›®å½•ç»“æž„ï¼ˆecc-mvp + examples å­ç›®å½•ï¼‰
	mkdir -p ecc-mvp/examples
	# 2. å¤åˆ¶ç¼–è¯‘å™¨å¯æ‰§è¡Œæ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•
	cp $(TARGET) ecc-mvp/
	# 3. ç”Ÿæˆæžç®€æµ‹è¯•ä»£ç ï¼ˆç¼–è¯‘å™¨å¯æ­£ç¡®å¤„ç†çš„ ELFCOST æºç ï¼‰
	echo "use x86_real;\nreg.ax = 0x1234;\nreg.bx = 0x5678;" > ecc-mvp/examples/test.elfc
	# 4. ç”Ÿæˆä½¿ç”¨è¯´æ˜Žæ–‡æ¡£ï¼ˆREADME.txtï¼‰
	cat > ecc-mvp/README.txt << EOF
	# ECC æœ€å°å¯è¡Œç‰ˆï¼ˆMVPï¼‰
	ELFCOST è¯­è¨€ä¸“ç”¨ç¼–è¯‘å™¨ï¼Œå½“å‰æ”¯æŒæ ¸å¿ƒåŠŸèƒ½ï¼š

	## å·²å®žçŽ°åŠŸèƒ½
	1. è§£æžæ¨¡å—å¼•å…¥è¯­å¥ï¼š`use x86_real;`ï¼ˆx86 å®žæ¨¡å¼æ”¯æŒï¼‰
	2. ç¼–è¯‘å¯„å­˜å™¨èµ‹å€¼è¯­å¥ï¼šå¦‚ `reg.ax = 0x1234;`ã€`reg.bx = 0x5678;`
	3. è¾“å‡º x86 å®žæ¨¡å¼äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ.bin æ ¼å¼ï¼Œå¯ç›´æŽ¥ç”¨ QEMU è¿è¡Œï¼‰
	4. å‘½ä»¤è¡ŒåŒæ¨¡å¼ï¼šdebugï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰ã€compileï¼ˆå¿«é€Ÿç¼–è¯‘ï¼‰

	## å¿«é€Ÿä½¿ç”¨
	### 1. è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºç¼–è¯‘æµç¨‹æ—¥å¿—ï¼‰
	./elfc-compiler debug -el examples/test.elfc -ma output.bin

	### 2. æ­£å¸¸æ¨¡å¼ï¼ˆæ— æ—¥å¿—ï¼Œå¿«é€Ÿç¼–è¯‘ï¼‰
	./elfc-compiler compile -el examples/test.elfc -ma output.bin

	## éªŒè¯ç¼–è¯‘ç»“æžœ
	ç”¨ `hexdump -C output.bin` æŸ¥çœ‹æœºå™¨ç ï¼Œé¢„æœŸè¾“å‡ºï¼š
	00000000  b8 34 12 bb 78 56                                 |.4..xV|
	ï¼ˆå¯¹åº” x86 æ±‡ç¼–ï¼šmov ax, 0x1234; mov bx, 0x5678ï¼‰

	## å·²çŸ¥é™åˆ¶
	- æš‚ä¸æ”¯æŒå†…å­˜æ“ä½œï¼ˆå¦‚ `memory.save-use(1024)`ï¼‰
	- æš‚ä¸æ”¯æŒå‡½æ•°å®šä¹‰ä¸Žè°ƒç”¨ï¼ˆå¦‚ `func print() { ... }`ï¼‰
	- å¤æ‚è¯­æ³•é”™è¯¯ä¼šç›´æŽ¥é€€å‡ºï¼ˆæœªåšä¼˜é›…é”™è¯¯å¤„ç†ï¼‰
	- ä»…æ”¯æŒ x86 16 ä½é€šç”¨å¯„å­˜å™¨ï¼ˆax/bx/cx/dxï¼‰
	EOF
	# 5. æ‰“åŒ…å®Œæˆæç¤º
	@echo "âœ… æ‰“åŒ…æˆåŠŸï¼æœ€ç»ˆç›®å½•ï¼š./ecc-mvp"
	@echo "ðŸ“ æ‰“åŒ…å†…å®¹ï¼šå¯æ‰§è¡Œæ–‡ä»¶ + ç¤ºä¾‹ä»£ç  + ä½¿ç”¨è¯´æ˜Ž"
# æ–°å¢žï¼šæžç®€æµ‹è¯•ç›®æ ‡ï¼ˆæ”¾åœ¨æ‰€æœ‰ç›®æ ‡æœ€åŽï¼‰
test-tab:
	@echo "Tab ç¼©è¿›æµ‹è¯•æˆåŠŸï¼"  # è¿™é‡Œå¿…é¡»ç”¨çº¯ Tab å¼€å¤´ï¼Œä¸èƒ½æœ‰ç©ºæ ¼